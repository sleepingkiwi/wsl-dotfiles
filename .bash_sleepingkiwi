# custom functionality for bash.
# loaded into .bashrc
# -
# source: https://github.com/sleepingkiwi/wsl-dotfiles


# colour references:
# http://misc.flogisoft.com/bash/tip_colors_and_formatting
# -
# basically \e[38;5;COLOURCODEm to set foreground colours in 256 colour supporting places


# customising the prompt
# --------------------------------------------------------------------------------------------------

# defining a function that will print our prompt (allows us to use variables/printf style)
_ () {
    printf "\n  \e[94m%s: \e[91m%s \n\e[0m" "$USER" "$PWD"
}

# set the prompt to be generated using the function above
PROMPT_COMMAND=_

# setting the PS1 marker before input
# colour formatting needs to be escaped weirdly in PS1...
# see: http://unix.stackexchange.com/questions/124407/what-color-codes-can-i-use-in-my-ps1-prompt
PS1='\[\e[38;5;166m\]• \[\e[0m\]'



# set up ssh-agent and add keys if required
# --------------------------------------------------------------------------------------------------

# https://www.freebsd.org/cgi/man.cgi?query=ssh-add&sektion=1
# https://stackoverflow.com/questions/40549332/how-to-check-if-ssh-agent-is-already-running-in-bash

# first check whether ssh-agent is running at all
# the $? arg in the `if` basically equates to the output value of the last command run
ssh-add -l &>/dev/null
if [ "$?" == 2 ]; then
    # 2 means - could not open a connection to your authentication agent.

    # try to load stored agent connection info from file if we can!
    test -r ~/.ssh-agent && \
        eval "$(<~/.ssh-agent)" >/dev/null

    # test if that worked
    ssh-add -l &>/dev/null
    if [ "$?" == 2 ]; then
        # we still can't connect so start agent and store agent connection info.
        # umask creates a file with defined permissions
        (umask 066; ssh-agent > ~/.ssh-agent)
        # run the contents of the file we just created
        eval "$(<~/.ssh-agent)" >/dev/null
    fi
fi

# load identities
ssh-add -l &>/dev/null
if [ "$?" == 1 ]; then
    # 1 means that the agent has no identities.
    # add our standard one/s (loads from ~/.ssh)
    # keys time out after 5 hours...
    ssh-add -t 5h
fi



# run on every terminal launch
# --------------------------------------------------------------------------------------------------

# sync _dev whenever we launch a terminal...
# maybe this is excessive?
bash ~/.dotfiles/_wsl-dev-sync.sh

# awww that's sweet
echo -e "\n\e[38;5;195mHi $USER, welcome back. I've really missed you buddy.\e[0m"



# aliases
# --------------------------------------------------------------------------------------------------

# quick access to script that syncs our _dev files
alias dev-sync='bash ~/.dotfiles/_wsl-dev-sync.sh'

# warn against using rm directly
alias rm='echo -e "\n• \e[38;5;166myou should probably use \e[0mtrash-put \e[38;5;166minstead. if you really want to use rm then use \e[0m\\\rm\n"'

alias c='clear'

# in WSL we can launch windows apps - i.e open the current dir in explorer by typing `o .`
alias o='explorer.exe'



# shortcuts for current projects
# --------------------------------------------------------------------------------------------------

# more general purpose shortcuts
alias cd-blurn='cd /mnt/s/_dev/knac/skill-shop--app/blurn'
alias cd-blurn-api='cd /mnt/s/_dev/knac/skill-shop--app/blurn-api'



# some general configuration and settings
# --------------------------------------------------------------------------------------------------

# Tell grep to highlight matches
export GREP_OPTIONS='--color=auto'
